{"version":3,"sources":["../src/index.ts","../src/middleware.ts"],"sourcesContent":["/**\n * @outboundiq/express\n * \n * OutboundIQ SDK for Express.js applications.\n * Automatically tracks all outbound HTTP calls made from your Express app.\n * \n * @example\n * ```typescript\n * import express from 'express';\n * import { init, userContextMiddleware } from '@outboundiq/express';\n * \n * const app = express();\n * \n * // Initialize OutboundIQ - patches fetch/http automatically\n * init({ apiKey: process.env.OUTBOUNDIQ_KEY });\n * \n * // Optional: track which user made each API call\n * app.use(userContextMiddleware());\n * \n * // Your routes - no changes needed!\n * app.get('/api/payment', async (req, res) => {\n *   // This fetch is automatically tracked\n *   const result = await fetch('https://api.stripe.com/v1/charges');\n *   res.json(await result.json());\n * });\n * \n * app.listen(3000);\n * ```\n */\n\n// Re-export everything from core/node\nexport {\n  // Core client functions\n  init,\n  getClient,\n  track,\n  flush,\n  setUserContext,\n  // Node.js specific\n  patchNodeHttp,\n  unpatchNodeHttp,\n  setUserContextResolver,\n  // Types\n  type OutboundIQConfig,\n  type UserContext,\n  type ApiCall,\n} from '@outboundiq/core/node';\n\n// Re-export API Intelligence functions from core\nexport {\n  recommend,\n  providerStatus,\n  endpointStatus,\n  type RecommendationResult,\n  type ProviderStatusResult,\n  type EndpointStatusResult,\n  type IntelligenceOptions,\n} from '@outboundiq/core';\n\n// Export Express-specific middleware\nexport {\n  userContextMiddleware,\n  setRequestUserContext,\n  getCurrentRequest,\n} from './middleware';\n\n// Import for our init wrapper\nimport { \n  init as coreInit,\n  patchNodeHttp,\n  patchFetch,\n} from '@outboundiq/core/node';\nimport type { OutboundIQConfig } from '@outboundiq/core';\n\n/**\n * Initialize OutboundIQ for Express.js\n * \n * This function:\n * 1. Initializes the core OutboundIQ client\n * 2. Patches Node.js http/https modules to track all outbound calls\n * 3. Patches global fetch (if available)\n * \n * After calling this, ALL outbound HTTP requests are automatically tracked,\n * regardless of which HTTP client library you use (fetch, axios, got, etc.)\n * \n * @example\n * ```typescript\n * import { init } from '@outboundiq/express';\n * \n * // Minimal setup\n * init({ apiKey: process.env.OUTBOUNDIQ_KEY });\n * \n * // With options\n * init({\n *   apiKey: process.env.OUTBOUNDIQ_KEY,\n *   debug: true,\n *   batchSize: 20,\n * });\n * ```\n */\nexport function initExpress(config: OutboundIQConfig): void {\n  // Initialize the core client\n  coreInit(config);\n  \n  // Patch Node.js http/https modules (for axios, got, node-fetch, etc.)\n  patchNodeHttp();\n  \n  // Patch global fetch (Node.js 18+ built-in fetch)\n  patchFetch();\n  \n  console.log('[OutboundIQ] Initialized for Express.js');\n}\n\n// Also export as default init for convenience\nexport { initExpress as default };\n\n","import { AsyncLocalStorage } from 'async_hooks';\nimport type { Request, Response, NextFunction } from 'express';\nimport { setUserContextResolver } from '@outboundiq/core/node';\nimport type { UserContext } from '@outboundiq/core';\n\n/**\n * AsyncLocalStorage to track the current request across async operations\n */\nconst requestStorage = new AsyncLocalStorage<Request>();\n\n/**\n * Flag to track if we've set up the resolver\n */\nlet resolverConfigured = false;\n\n/**\n * Extract user context from Express request\n */\nfunction extractUserContext(req: Request): UserContext | null {\n  // Check for user on request (set by passport, express-session, etc.)\n  const user = (req as any).user;\n  \n  if (!user) {\n    return null;\n  }\n\n  // Try common user ID field names\n  const userId = user.id ?? user._id ?? user.userId ?? user.sub ?? null;\n  \n  // Get user type from constructor name or explicit type\n  const userType = user.type ?? user.role ?? user.constructor?.name ?? 'User';\n\n  return {\n    userId: userId ? String(userId) : null,\n    userType: String(userType),\n    context: 'authenticated',\n  };\n}\n\n/**\n * Configure the global user context resolver\n * This is called once when middleware is first used\n */\nfunction configureResolver(): void {\n  if (resolverConfigured) return;\n\n  setUserContextResolver(() => {\n    const req = requestStorage.getStore();\n    if (!req) return null;\n    return extractUserContext(req);\n  });\n\n  resolverConfigured = true;\n}\n\n/**\n * Express middleware that captures the current request for user context tracking.\n * \n * This middleware uses AsyncLocalStorage to propagate the request object\n * across async boundaries, allowing the SDK to automatically capture\n * user context from `req.user` for each outbound API call.\n * \n * @example\n * ```typescript\n * import express from 'express';\n * import { init, userContextMiddleware } from '@outboundiq/express';\n * \n * const app = express();\n * \n * init({ apiKey: process.env.OUTBOUNDIQ_KEY });\n * \n * // Add after your auth middleware (passport, etc.)\n * app.use(userContextMiddleware());\n * \n * app.get('/api/users', async (req, res) => {\n *   // API calls here will automatically include user context\n *   const data = await fetch('https://api.example.com/users');\n *   res.json(await data.json());\n * });\n * ```\n */\nexport function userContextMiddleware() {\n  // Set up the resolver on first use\n  configureResolver();\n\n  return (req: Request, _res: Response, next: NextFunction): void => {\n    // Run the rest of the request inside the async context\n    requestStorage.run(req, () => {\n      next();\n    });\n  };\n}\n\n/**\n * Manually set user context for the current request.\n * Use this when you need to override automatic user detection.\n * \n * @example\n * ```typescript\n * app.post('/api/webhook', (req, res) => {\n *   // Webhooks don't have req.user, but we know the context\n *   setRequestUserContext(req, {\n *     userId: req.body.customer_id,\n *     userType: 'Customer',\n *     context: 'webhook',\n *   });\n *   \n *   // Now API calls will have this context\n *   await fetch('https://api.stripe.com/...');\n * });\n * ```\n */\nexport function setRequestUserContext(req: Request, context: UserContext): void {\n  (req as any).__outboundiq_context = context;\n}\n\n/**\n * Get the current request from async context (if available)\n */\nexport function getCurrentRequest(): Request | undefined {\n  return requestStorage.getStore();\n}\n\n"],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA+BA,IAAAA,eAeO;AAGP,kBAQO;;;ACzDP,yBAAkC;AAElC,kBAAuC;AAMvC,IAAM,iBAAiB,IAAI,qCAA2B;AAKtD,IAAI,qBAAqB;AAKzB,SAAS,mBAAmB,KAAkC;AAE5D,QAAM,OAAQ,IAAY;AAE1B,MAAI,CAAC,MAAM;AACT,WAAO;AAAA,EACT;AAGA,QAAM,SAAS,KAAK,MAAM,KAAK,OAAO,KAAK,UAAU,KAAK,OAAO;AAGjE,QAAM,WAAW,KAAK,QAAQ,KAAK,QAAQ,KAAK,aAAa,QAAQ;AAErE,SAAO;AAAA,IACL,QAAQ,SAAS,OAAO,MAAM,IAAI;AAAA,IAClC,UAAU,OAAO,QAAQ;AAAA,IACzB,SAAS;AAAA,EACX;AACF;AAMA,SAAS,oBAA0B;AACjC,MAAI,mBAAoB;AAExB,0CAAuB,MAAM;AAC3B,UAAM,MAAM,eAAe,SAAS;AACpC,QAAI,CAAC,IAAK,QAAO;AACjB,WAAO,mBAAmB,GAAG;AAAA,EAC/B,CAAC;AAED,uBAAqB;AACvB;AA4BO,SAAS,wBAAwB;AAEtC,oBAAkB;AAElB,SAAO,CAAC,KAAc,MAAgB,SAA6B;AAEjE,mBAAe,IAAI,KAAK,MAAM;AAC5B,WAAK;AAAA,IACP,CAAC;AAAA,EACH;AACF;AAqBO,SAAS,sBAAsB,KAAc,SAA4B;AAC9E,EAAC,IAAY,uBAAuB;AACtC;AAKO,SAAS,oBAAyC;AACvD,SAAO,eAAe,SAAS;AACjC;;;ADtDA,IAAAC,eAIO;AA6BA,SAAS,YAAY,QAAgC;AAE1D,mBAAAC,MAAS,MAAM;AAGf,kCAAc;AAGd,+BAAW;AAEX,UAAQ,IAAI,yCAAyC;AACvD;","names":["import_node","import_node","coreInit"]}